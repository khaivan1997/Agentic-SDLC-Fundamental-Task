# Backend PostgreSQL Migration Plan

## Purpose
Migrate the backend database from H2 (in-memory) to PostgreSQL so the MCP server and the main backend can share the same `tasks` table.

## Current State
- **Database**: H2 in-memory (`jdbc:h2:mem:taskdb`)
- **Dependency**: `com.h2database:h2` (runtime scope)
- **Config**: `backend/src/main/resources/application.properties`
- **Hibernate dialect**: `org.hibernate.dialect.H2Dialect`

## Target State
- **Database**: PostgreSQL on `localhost:5436/taskdb`
- **Dependency**: `org.postgresql:postgresql` (runtime scope)
- **Hibernate dialect**: `org.hibernate.dialect.PostgreSQLDialect`

## Changes Required

### 1. `backend/pom.xml` — Swap H2 for PostgreSQL

Remove:
```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>runtime</scope>
</dependency>
```

Add:
```xml
<dependency>
    <groupId>org.postgresql</groupId>
    <artifactId>postgresql</artifactId>
    <scope>runtime</scope>
</dependency>
```

Keep H2 for tests only (optional):
```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```

### 2. `backend/src/main/resources/application.properties` — Update connection

Before:
```properties
spring.datasource.url=jdbc:h2:mem:taskdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=password
spring.jpa.database-platform=org.hibernate.dialect.H2Dialect
spring.h2.console.enabled=true
spring.h2.console.path=/h2-console
```

After:
```properties
spring.datasource.url=jdbc:postgresql://localhost:5436/taskdb
spring.datasource.username=taskuser
spring.datasource.password=taskpass
spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
```

### 3. PostgreSQL Setup (Docker)

The database and user are created automatically by the Docker container's environment variables (`POSTGRES_DB`, `POSTGRES_USER`, `POSTGRES_PASSWORD`). No manual SQL is needed.

Hibernate's `ddl-auto=update` will create/update the `tasks` table schema automatically on application startup.

### 4. Entity Compatibility

No Java code changes are needed. The `Task` entity and its annotations (`@Entity`, `@Table`, `@Column`, `@Enumerated`) are database-agnostic and work identically with both H2 and PostgreSQL. Hibernate DDL auto-update (`ddl-auto=update`) will create the `tasks` table automatically on first run.

### 5. Test Strategy

For unit/integration tests, keep H2 as a test-scoped dependency and add `src/test/resources/application-test.properties` pointing back to H2. This way:
- **Production** runs against PostgreSQL.
- **Tests** run against H2 (fast, no external DB needed).

```properties
# backend/src/test/resources/application.properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
spring.jpa.database-platform=org.hibernate.dialect.H2Dialect
```
